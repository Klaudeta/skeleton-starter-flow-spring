<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="chargebee-checkout">
    <template>
        <style>
            :host {
                display: block;
                text-decoration: underline;
            }
            :host(:hover) {
                cursor: pointer;
            }
        </style>

        [[label]]

    </template>

    <script>
        class ChargebeeCheckout extends Polymer.Element {
            static get is() {
                return 'chargebee-checkout';
            }

            static get properties() {
                return {
                    dataCbType:{
                        type: String,
                        value: "checkout",
                        reflectToAttribute:true
                    },
                    dataCbPlanId:{
                        type: String,
                        value: "cbdemo_free",
                        reflectToAttribute:true
                    },
                    label:{
                        type: String,
                        value: 'Checkout',
                        reflectToAttribute:true
                    },
                    customerEmail:{
                        type: String,
                        notify: true
                    }
                };
            }

            ready(){
                super.ready();
                this._clickListener = e => this._proceedToCheckout(e);
                this.addEventListener("click", this._clickListener);
            }

            _proceedToCheckout(e){
                var cbInstance = Chargebee.getInstance();
                var cart = cbInstance.getCart();
                cart.setCustomer({email: this.customerEmail});
            }

            connectedCallback() {
                super.connectedCallback();

                Chargebee.registerAgain();

                var that = this;
                Chargebee.getInstance().setCheckoutCallbacks(function(cart) {
                    return {
                        loaded: function() {
                            console.log("checkout opened");
                        },
                        close: function() {
                            that.dispatchEvent(new CustomEvent("cancel"));
                            console.log("checkout closed");

                        },
                        success: function(hostedPageId) {
                            const evt = that.dispatchEvent(new CustomEvent("success", {detail: {hostedPageId: hostedPageId}}));
                        },
                        step: function(value) {
                            // value -> which step in checkout
                            console.log(value);
                        }
                    }
                });
            }

        }
        customElements.define(ChargebeeCheckout.is, ChargebeeCheckout);
    </script>
</dom-module>